# TiDB 冷热数据分层存储

## he3团队

队长：薛港 

队员：时丕显、沈政

## 项目介绍

**以极简单的方式实现冷热数据分离，冷数据保存在s3外部表中**

针对普通表：实现**insert into select**的方式完成冷热数据分离：

- 支持创建**s3**外部表
- 支持通过**insert into s3_table select from tikv_table where ...** ，把**tikv** 内部表的数据转储到**s3**对象存储上

- 支持通过**insert into tikv_table select from s3_table where ...** ，把**s3**外部表的数据转储到**tikv**内部表，

**针对分区表：自动完成分片表转化成s3外部表，保留主表和s3外部表的主从关系**

支持通过**Alter** 分区表操作，把**tikv** 内部分区表的数据自动转储到对应的**s3**外部表中，自动完成以下几件事：

- 内部**tikv**分区表数据转存到**s3**对象存储中

- 更改分区表元数据，把**tikv**内部分区表转化成**s3**外部表，核心要点要保留**s3**外部表和主表的分区关系

- 删除**tikv**内部分区表数据

转换后**s3**外部分区表对用户完全透明，对用户来说，**s3**外部表就是主表的一个分片表。例如针对主表的查询结果包含部分**tikv**内部分片表以及部分**s3**外部表对应的分片表数据，那么返回的结果就会来自两部分：tikv内部分片表，以及**s3**外部表

**保证用户使用s3外部表和tikv内部表没有任何区别**

- **s3** 外部表支持所有的数据类型
- **s3**外部表支持所有的算子
- 优化**s3**外部表操作性能在用户可接受的范围内

通过支持谓词(逻辑运算、比较运算、数值运算），聚合函数、Limit等算子下推到S3节点，利用s3的计算能力提升查询性能。

## 背景&动机

我们团队是做云数据库服务开发，降低用户在云上使用数据库的成本是我们一直追求的目标。 随着用户数据量的持续增长，我们发现存储成本占数据库总成本的比率越来越高。因此我们选择冷热数据分层存储降低存储成本

![image](https://github.com/shenzhengcmss/tidb-support-s3/blob/main/tidb-for-s3.png)


## 项目设计

## 详细设计

为了实现冷热数据分离，并且达到期望所有效果，我们开发修改了TIDB一些模块：

**SQL Parser模块,系统表模块:**

- 增加一个新的系统表，用于保存s3元数据， 每一条记录对应一个s3存储元数据：包含s3的endpoint,  access key, secret key， s3 bucket。
  insert into mysql.serverobject  values("s3object","http://192.168.117.220:9000","minioadmin", "minioadmin","s3bucket");

- 支持创建外部表，相比普通表增加了s3option 选型，对应s3元数据对象，外部表对应s3的存储路径：Bucketname/DBName/TableName
  create table s3_table(id1 int8,id2 char(30)) s3options s3object; 

- 支持分片表自动转换成s3外部表   

  Alter table employees alter partition employees_01 s3options s3object

**执行器模块：**

- 能够区分操作表是否是s3外部表，如果是外部表，写入时，数据以256M 为粒度保存到s3的一个对象中 , 当查询s3 外部表时，s3对象会被以流式的方式装配到chunk中，以支持上层算子操作
- 支持算子下推到s3节点，利用s3节点的计算能力加速s3外部表的性能
- s3 外部表支持所有的数据类型，存储在s3的数据按s3外部表的schema对应的数据类型保存到chunk里，相关列都会基于数据类型编码
- 支持Alter 实现内部分片表数据自动转储到s3 外部表中，同时保留主表和s3外部表的主从关系不变

**优化器模块：**

- 少量无法下推s3的算子，我们修改了优化器阻止这部分算子下推。 当前不支持的算子，主要就是包含TopN 算子
